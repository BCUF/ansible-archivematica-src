---
# ubuntu block
- block:
    - name: "Install dashboard ext. deps. repo keys"
      become: yes
      apt_key:
        id: "{{ item.id }}"
        url: "{{ item.url }}"
        state: "present"
        validate_certs: "{{ item.validate_certs }}"
      with_items: "{{ dashboard.osdeps_repokeys }}"
      when:
        - "dashboard.osdeps_repokeys"

    - name: "Add dashboard ext. deps. repos"
      become: yes
      apt_repository:
        repo: "{{ item }}"
        state: "present"
      with_items: "{{ dashboard.osdeps_repos }}"
      when:
        - "dashboard.osdeps_repos"

    - name: update APT Cache
      become: yes
      apt:
        update_cache: yes
        force_apt_get: yes

    - name: Wait for any possibly running unattended upgrade to finish
      become: yes
      raw: systemd-run --property="After=apt-daily.service apt-daily-upgrade.service" --wait /bin/true

    - name: "Install dashboard ext. package deps."
      become: yes
      apt:
        pkg: "{{ dashboard.osdeps_packages | json_query('[].name') }}"
        state: "latest"
      when:
        - "dashboard.osdeps_packages"

  when:
    - ansible_distribution == "Ubuntu"

# Centos/RH block
- block:
    - name: "Add dashboard ext. deps. repos (RH/CentOS)"
      yum_repository:
        name: "{{ item['name'] }}"
        description: "{{ item['description'] }}"
        baseurl: "{{ item['baseurl'] }}"
        gpgcheck: "{{ item['gpgcheck'] }}"
        enabled: "{{ item['enabled'] }}"
      with_items: "{{ dashboard.osdeps_repos }}"
      when:
        - dashboard.osdeps_repos

    - name: "Install dashboard ext. package deps. (RH/CentOS)"
      yum:
        name: "{{ dashboard.osdeps_packages | json_query('[].name') }}"
        state: "latest"
      when:
        - dashboard.osdeps_packages is defined and dashboard.osdeps_packages

    - name: "Install dashboard ext. package deps. (RH/CentOS) (2)"
      yum:
        name: "{{ dashboard.osdeps_packages_2 | json_query('[].name') }}"
        state: "latest"
      when:
        - dashboard.osdeps_packages_2 is defined and dashboard.osdeps_packages_2

    - name: "Install dashboard ext. package deps. (RH/CentOS) (3)"
      yum:
        name: "{{ dashboard.osdeps_packages_3 | json_query('[].name') }}"
        state: "latest"
      when:
        - dashboard.osdeps_packages_3 is defined and dashboard.osdeps_packages_3

  when:
    - ansible_distribution == "RedHat" or ansible_distribution == "CentOS"
