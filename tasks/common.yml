---

- name: "Expand archivematica_src_dir"
  set_fact:
    archivematica_src_dir: "{{ archivematica_src_dir|expanduser }}"

#
# Create `archivematica` user
#

- name: "Create user archivematica"
  user:
    name: "archivematica"
    uid: "333"
    system: "yes"
    groups: "audio"
    home: "/var/lib/archivematica"

- name: "Common configuration for source installs"
  block:

  #
  # Prepare pip
  #

  - name: "Ensure pip is not installed from packages"
    package:
      name: "{{ item }}"
      state: "absent"
    with_items:
      - "python-pip"
      - "python2-pip"

  - name: "Download get-pip.py"
    get_url:
      url: "https://bootstrap.pypa.io/get-pip.py"
      dest: "/root/get-pip.py"

  - name: "Install pip with get-pip.py"
    command: "python get-pip.py"
    args:
      chdir: "/root/"

  - name: "Install virtualenv with pip"
    pip:
      name: "{{ item }}"
      state: "latest"
    with_items:
      - "virtualenv"


  - name: "Add archivematica user permissions in visudo file"
    lineinfile:
      dest: "/etc/sudoers"
      state: "present"
      regexp: "^archivematica ALL\\="
      line: "archivematica ALL=NOPASSWD:/bin/mv,/bin/chown,/bin/chmod,/usr/bin/find,/usr/bin/gs,/usr/bin/inkscape"
      validate: "/usr/sbin/visudo -cf %s"
    when: archivematica_src_enable_sudoers is defined and archivematica_src_enable_sudoers|bool

  - name: "Remove archivematica user permissions in visudo file"
    lineinfile:
      dest: "/etc/sudoers"
      state: "absent"
      regexp: "^archivematica ALL\\="
      line: "archivematica ALL=NOPASSWD:/bin/mv,/bin/chown,/bin/chmod,/usr/bin/find,/usr/bin/gs,/usr/bin/inkscape"
      validate: "/usr/sbin/visudo -cf %s"
    when: archivematica_src_enable_sudoers is not defined or not archivematica_src_enable_sudoers|bool

#
# Prepare `archivematica_src_dir`
#

  - name: "Create archivematica_src_dir"
    file:
      state: "directory"
      path: "{{ archivematica_src_dir }}"
  when: (archivematica_src_install_am|bool or archivematica_src_install_ss|bool)
#
# SELinux configuration
#
- name: "Install necessary packages required by this ansible role"
  yum:
    name: "{{ item }}"
    state: "latest"
  with_items:
    - "libsemanage-python"
    - "policycoreutils-python"
  when:
    - ansible_os_family == "RedHat"

- name: "Configure SELinux httpd permissions "
  become: "yes"
  seboolean:
    name: "{{ item }}"
    state: "yes"
    persistent: "yes"
  with_items:
    - "httpd_can_network_connect"       # Allow nginx connections to Gunicorn
    - "httpd_can_network_connect_db"    # Allow nginx to connect to MySQL
    - "httpd_setrlimit"                 # Allow nginx to change system limits
  when:
    - ansible_selinux is defined and ansible_selinux != False and ansible_selinux.status == 'enabled'
    - ansible_os_family == "RedHat"

- name: "SELinux: Allow nginx to use ports 8000 and 8001"
  become: "yes"
  seport:
    ports: "8000,8001"
    proto: "tcp"
    setype: "http_port_t"
    state: "present"
  when:
    - ansible_selinux is defined and ansible_selinux != False and ansible_selinux.status == 'enabled'
    - ansible_os_family == "RedHat"

- name: "Change home dir perms (to make transfer source visible)"
  command: "chmod 755 $HOME"
  tags: "homeperms"
  become: "no"
  when:
    - ansible_os_family == "RedHat"

#TODO: Use dict
- name: "Add Archivematica RPM repositories"
  block:
  - name: "Add AM repos"
    yum_repository: 
      name: "archivematica"
      description: "archivematica-main"
      baseurl: "http://jenkins-ci.archivematica.org/repos/am-packbuild/1.10.0/centos7/"
      repo_gpgcheck: "no"
  - name: "Add AM repos"
    yum_repository: 
      name: "archivematica-ss"
      description: "archivematica-ss"
      baseurl: "http://jenkins-ci.archivematica.org/repos/am-packbuild/0.15.0/centos7/"
      repo_gpgcheck: "no"

  - name: "Add AM repos"
    yum_repository: 
      name: "archivematica-extras"
      description: "archivematica-extras"
      baseurl: "https://packages.archivematica.org/1.10.x/centos-extras"
      repo_gpgcheck: "no"
  when: "(archivematica_rpm_install_am|bool or archivematica_rpm_install_ss|bool)"


