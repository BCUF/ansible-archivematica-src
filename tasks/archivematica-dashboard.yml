---

- name: "Create user archivematicadashboard"
  user:
    name: "archivematicadashboard"
    uid: "334"
    system: "yes"
    home: "/var/lib/archivematica-dashboard"

- name: "Copy archivematica-dashboard source files"
  file:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    state: "link"
  with_items:
    - src: "{{ archivematica_src_dir }}/archivematica/src/dashboard/src"
      dest: "/usr/share/archivematica/dashboard"

- name: "Install archivematica-dashboard package dependencies"
  apt:
    pkg: "{{ item }}"
    state: "latest"
  with_items:
    - "apache2-mpm-prefork"
    - "libapache2-mod-wsgi"
    - "python-pip"
    - "python-gearman"
    - "python-simplejson"

- name: "Install archivematica-dashboard pip dependencies"
  pip:
    requirements: "/usr/share/archivematica/dashboard/requirements.txt"

- name: "Enable mod-wsgi in Apache"
  command: "a2enmod wsgi"
  notify:
    - "Restart Apache"

- name: "Set MCP database charset"
  command: "mysql -u archivematica -pdemo MCP -e 'ALTER DATABASE MCP CHARACTER SET utf8 COLLATE utf8_unicode_ci'"
  sudo: "no"

- name: "Create archivematica-dashboard log directories"
  file:
    dest: "{{ item }}"
    state: "directory"
    owner: "archivematica"
    group: "archivematica"
    mode: "g+s"
  with_items:
    - "/var/log/archivematica/dashboard"

- name: "Invoke django syncdb"
  command: "/usr/share/archivematica/dashboard/manage.py syncdb --settings='settings.common' --noinput"
  sudo_user: "archivematica"

- name: "Call mysql_dev script"
  command: "./mysql_dev.sh MCP"
  args:
    chdir: "{{ archivematica_src_dir }}/archivematica/src/MCPServer/share/"
    creates: "{{ archivematica_src_dir }}/archivematica/src/MCPServer/share/mysql_dev.complete"

- name: "Remove default Apache server"
  command: "a2dissite 000-default"
  notify:
    - "Restart Apache"

- name: "Copy Apache config file"
  copy:
    src: "apache.default"
    dest: "/etc/apache2/sites-available/default.conf"
  notify:
    - "Restart Apache"

- name: "Enable Apache site"
  command: "a2ensite default"
  args:
    creates: "/etc/apache2/sites-enabled/default.conf"
  notify:
    - "Restart Apache"

- name: "Get archivematica-dashboard configuration"
  get_url:
    url: "https://raw.githubusercontent.com/artefactual/archivematica/stable/1.2.x/localDevSetup/apache/apache.default"
    dest: "/etc/apache2/sites-available/default"

- name: "Enable services"
  service:
    name: "{{ item }}"
    state: "reloaded"
    enabled: "yes"
  with_items:
    - "elasticsearch"
    - "apache2"